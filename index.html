<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mafia Game</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@500;600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --burgundy:#6F263D;
      --burgundy-dark:#5c1f32;
      --blue:#236192;
      --blue-dark:#1b4e6f;

      --panel: rgba(255,255,255,.08);
      --line: rgba(255,255,255,.14);
      --muted: rgba(255,255,255,.72);

      --gold:#FFCC33;

      --radius: 18px;
      --shadow: 0 18px 50px rgba(0,0,0,.55);
      --shadow-sm: 0 10px 28px rgba(0,0,0,.42);
      --glow-blue: 0 0 34px rgba(35,97,146,.35);
      --glow-gold: 0 0 28px rgba(255,204,51,.22);

      --circle-size: min(84vw, 820px);

      /* pill size used by JS too */
      --pill-w: 132px;
      --pill-h: 58px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding: 26px 18px 40px;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: #fff;
      background:
        radial-gradient(1200px 900px at 50% -200px, rgba(35,97,146,.35), transparent 60%),
        radial-gradient(900px 700px at 10% 20%, rgba(255,204,51,.10), transparent 55%),
        radial-gradient(900px 700px at 90% 25%, rgba(255,204,51,.08), transparent 55%),
        linear-gradient(180deg, rgba(111,38,61,.90), rgba(11,12,16,.96) 58%, rgba(0,0,0,.98));
    }

    h1{
      margin: 10px 0 14px;
      font-family: Oswald, Inter, sans-serif;
      letter-spacing: .08em;
      text-transform: uppercase;
      font-size: clamp(28px, 3.1vw, 44px);
      text-shadow: 0 10px 35px rgba(0,0,0,.55);
    }

    .top-wrap{
      width: min(1100px, 100%);
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 14px;
      margin-bottom: 18px;
    }
    @media (max-width: 900px){
      .top-wrap{ grid-template-columns: 1fr; }
    }

    .panel{
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 16px 16px 14px;
    }

    .panel h2{
      margin: 0 0 10px;
      font-family: Oswald, Inter, sans-serif;
      letter-spacing: .06em;
      text-transform: uppercase;
      font-size: 18px;
      color: rgba(255,255,255,.92);
    }

    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin: 10px 0 6px;
      letter-spacing: .02em;
    }

    input[type="text"], input[type="number"]{
      width: 100%;
      border: 1px solid rgba(255,255,255,.18);
      border-radius: 12px;
      background: rgba(0,0,0,.35);
      color: #fff;
      padding: 10px 12px;
      outline: none;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.08);
    }
    input[type="text"]::placeholder{ color: rgba(255,255,255,.45); }

    .row{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .btn{
      border: 1px solid rgba(255,255,255,.16);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      color:#fff;
      border-radius: 14px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight: 700;
      letter-spacing: .02em;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease, background .12s ease;
      box-shadow: 0 10px 22px rgba(0,0,0,.35);
      user-select:none;
    }
    .btn:hover{
      transform: translateY(-1px);
      border-color: rgba(255,255,255,.26);
      box-shadow: 0 14px 28px rgba(0,0,0,.42), var(--glow-blue);
    }
    .btn:active{ transform: translateY(0px) scale(.99); }

    .btn.primary{
      border-color: rgba(255,204,51,.38);
      background:
        linear-gradient(180deg, rgba(255,204,51,.22), rgba(255,204,51,.08)),
        linear-gradient(180deg, rgba(35,97,146,.60), rgba(27,78,111,.62));
      box-shadow: 0 16px 32px rgba(0,0,0,.48), var(--glow-gold);
    }
    .btn.primary:hover{ box-shadow: 0 18px 38px rgba(0,0,0,.55), var(--glow-gold); }

    .btn.danger{
      background: linear-gradient(180deg, rgba(139,35,49,.75), rgba(92,31,50,.80));
      box-shadow: 0 14px 28px rgba(0,0,0,.45);
    }

    .btn.small{
      padding: 8px 10px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 12px;
    }

    .hint{
      margin-top: 8px;
      font-size: 12px;
      color: rgba(255,255,255,.72);
      line-height: 1.25;
    }

    .error{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(255,60,60,.12);
      border: 1px solid rgba(255,60,60,.22);
      color: rgba(255,255,255,.92);
      display:none;
      font-size: 13px;
    }

    .status{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
      justify-content:space-between;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.26);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.08);
      font-size: 12px;
      color: rgba(255,255,255,.86);
    }
    .badge strong{
      font-family: Oswald, Inter, sans-serif;
      letter-spacing:.06em;
      text-transform: uppercase;
      font-size: 13px;
      color:#fff;
    }
    .dot{
      width: 10px; height: 10px; border-radius: 999px;
      background: var(--gold);
      box-shadow: var(--glow-gold);
    }
    .dot.night{ background: rgba(139,35,49,.95); box-shadow: 0 0 26px rgba(139,35,49,.30); }
    .dot.day{ background: rgba(35,97,146,.95); box-shadow: 0 0 26px rgba(35,97,146,.30); }

    .stage-wrap{
      width: min(1100px, 100%);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 12px;
    }

    .container{
      position: relative;
      width: var(--circle-size);
      height: var(--circle-size);
      border-radius: 50%;
      overflow:hidden;
      box-shadow: var(--shadow), 0 0 0 7px rgba(255,255,255,.06), var(--glow-blue);
      border: 1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(circle at 50% 44%, rgba(255,255,255,.08), transparent 42%),
        radial-gradient(circle at 50% 50%, #14161b 0%, #05060a 55%, #000 100%);
      display:flex;
      justify-content:center;
      align-items:center;
    }

    .container::before{
      content:"";
      position:absolute;
      inset:-8%;
      background:
        radial-gradient(closest-side at 50% 40%, rgba(35,97,146,.22), transparent 62%),
        radial-gradient(closest-side at 52% 55%, rgba(255,204,51,.10), transparent 64%),
        radial-gradient(closest-side at 50% 50%, rgba(0,0,0,.25), rgba(0,0,0,.65));
      pointer-events:none;
      mix-blend-mode: screen;
      opacity:.85;
    }

    /* Player layer */
    #player-list{
      position:absolute;
      inset:0;
      pointer-events:none;
    }

    /* FIXED ALIGNMENT:
       Anchor each pill to center (50/50) then offset by --tx/--ty (computed in JS).
       Hover scaling never changes its anchor point. */
    .player-oval{
      position:absolute;
      left: 50%;
      top: 50%;
      width: var(--pill-w);
      height: var(--pill-h);
      border-radius: 999px;

      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: 2px;

      pointer-events:auto;
      cursor:pointer;
      user-select:none;

      --tx: 0px;
      --ty: 0px;
      --s: 1;

      transform: translate(-50%, -50%) translate(var(--tx), var(--ty)) scale(var(--s));

      background:
        linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.04)),
        linear-gradient(180deg, rgba(139,35,49,.90), rgba(92,31,50,.92));
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 16px 30px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.10), 0 0 22px rgba(139,35,49,.18);
      transition: transform .12s ease, filter .12s ease, opacity .12s ease, box-shadow .12s ease;
      text-align:center;
      padding: 6px 10px;
    }
    .player-oval:hover{
      --s: 1.04;
      box-shadow: 0 18px 34px rgba(0,0,0,.60), inset 0 1px 0 rgba(255,255,255,.14), 0 0 26px rgba(255,204,51,.16);
    }

    .player-name{
      font-weight: 800;
      font-size: 13px;
      letter-spacing: .02em;
      line-height: 1.05;
      max-width: 100%;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .player-oval.dead{
      background:
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)),
        linear-gradient(180deg, rgba(60,60,60,.72), rgba(22,22,22,.84));
      border-color: rgba(255,255,255,.10);
      box-shadow: 0 14px 26px rgba(0,0,0,.60), inset 0 1px 0 rgba(255,255,255,.06);
      filter: grayscale(.4);
      opacity: .85;
    }
    .player-oval.dead .player-name{
      text-decoration: line-through;
      color: rgba(255,255,255,.78);
    }

    /* Phase button */
    .btn-next-phase{
      position:absolute;
      width: 130px;
      height: 130px;
      border-radius: 50%;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      cursor:pointer;
      user-select:none;
      z-index: 5;

      background:
        radial-gradient(circle at 30% 28%, rgba(255,255,255,.22), transparent 38%),
        linear-gradient(180deg, rgba(255,204,51,.18), rgba(255,204,51,.06)),
        linear-gradient(180deg, rgba(35,97,146,.92), rgba(27,78,111,.92));
      border: 1px solid rgba(255,204,51,.40);
      box-shadow: 0 26px 52px rgba(0,0,0,.65), var(--glow-gold);
      text-align:center;
      transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
      padding: 10px;
    }
    .btn-next-phase:hover{
      transform: scale(1.03);
      box-shadow: 0 30px 60px rgba(0,0,0,.70), 0 0 34px rgba(255,204,51,.26);
      filter: brightness(1.05);
    }
    .btn-next-phase .big{
      font-family: Oswald, Inter, sans-serif;
      font-size: 20px;
      letter-spacing: .10em;
      text-transform: uppercase;
      color: #fff;
      text-shadow: 0 10px 24px rgba(0,0,0,.55);
      line-height: 1.05;
    }
    .btn-next-phase .small{
      font-size: 11px;
      color: rgba(255,255,255,.80);
      margin-top: 4px;
      line-height: 1.2;
    }

    .countdown-oval{
      position:absolute;
      width: 62%;
      height: 62%;
      border-radius: 50%;
      display:none;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      text-align:center;
      z-index: 20;

      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,.16), transparent 40%),
        linear-gradient(180deg, rgba(255,204,51,.12), rgba(255,204,51,.05)),
        linear-gradient(180deg, rgba(35,97,146,.92), rgba(27,78,111,.92));
      border: 10px solid rgba(0,0,0,.85);
      box-shadow: 0 30px 80px rgba(0,0,0,.75), var(--glow-blue);
      backdrop-filter: blur(6px);
    }
    #countdown{
      font-family: Oswald, Inter, sans-serif;
      font-size: clamp(48px, 6vw, 96px);
      letter-spacing: .05em;
      color: #fff;
      text-shadow: 0 18px 45px rgba(0,0,0,.62);
    }
    .timer-actions{
      display:flex;
      gap: 10px;
      margin-top: 18px;
      flex-wrap: wrap;
      justify-content:center;
    }

    .overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.68);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 10000;
      padding: 18px;
    }
    .modal{
      width: min(760px, 100%);
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.14);
      background:
        radial-gradient(circle at 18% 8%, rgba(255,204,51,.12), transparent 36%),
        radial-gradient(circle at 80% 12%, rgba(35,97,146,.18), transparent 42%),
        rgba(17,18,23,.92);
      box-shadow: 0 30px 90px rgba(0,0,0,.75);
      padding: 18px 18px 16px;
    }
    .modal h3{
      margin: 0 0 10px;
      font-family: Oswald, Inter, sans-serif;
      letter-spacing: .08em;
      text-transform: uppercase;
      font-size: 18px;
    }
    .modal p{
      margin: 8px 0 0;
      color: rgba(255,255,255,.86);
      line-height: 1.35;
    }
    .modal .actions{
      display:flex;
      gap: 10px;
      justify-content:flex-end;
      margin-top: 14px;
      flex-wrap: wrap;
    }

    .win-circle{
      width: min(520px, 84vw);
      height: min(520px, 84vw);
      border-radius: 50%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;

      background:
        radial-gradient(circle at 28% 22%, rgba(255,255,255,.18), transparent 42%),
        linear-gradient(180deg, rgba(255,204,51,.14), rgba(255,204,51,.06)),
        linear-gradient(180deg, rgba(35,97,146,.92), rgba(27,78,111,.92));
      border: 10px solid rgba(0,0,0,.9);
      box-shadow: 0 40px 120px rgba(0,0,0,.80), var(--glow-gold);
      position: relative;
      overflow:hidden;
    }
    .win-circle::before{
      content:"";
      position:absolute;
      inset:-30%;
      background: linear-gradient(120deg, transparent 35%, rgba(255,255,255,.18), transparent 65%);
      transform: rotate(12deg);
      animation: shimmer 2.2s ease-in-out infinite;
      opacity: .55;
      pointer-events:none;
    }
    @keyframes shimmer{
      0%{ transform: translateX(-20%) rotate(12deg); }
      50%{ transform: translateX(20%) rotate(12deg); }
      100%{ transform: translateX(-20%) rotate(12deg); }
    }

    #win-message{
      font-family: Oswald, Inter, sans-serif;
      font-size: clamp(44px, 5.8vw, 92px);
      letter-spacing: .06em;
      text-transform: uppercase;
      color:#fff;
      text-shadow: 0 20px 55px rgba(0,0,0,.70);
      margin: 0 0 10px;
      padding: 0 18px;
      line-height: 1.02;
    }
    .win-sub{
      font-size: 13px;
      color: rgba(255,255,255,.80);
      margin-bottom: 18px;
    }

    .columns{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
      margin-top: 10px;
    }
    @media (max-width: 900px){
      .columns{ grid-template-columns: 1fr; }
    }
    .col{
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      padding: 12px;
    }
    .col h4{
      margin:0 0 10px;
      font-family: Oswald, Inter, sans-serif;
      letter-spacing: .08em;
      text-transform: uppercase;
      font-size: 14px;
      color: rgba(255,255,255,.90);
    }
    .opt{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 8px 8px;
      border-radius: 12px;
      border: 1px solid transparent;
      transition: border-color .12s ease, background .12s ease;
    }
    .opt:hover{
      background: rgba(255,255,255,.06);
      border-color: rgba(255,255,255,.10);
    }
    .opt span{
      font-size: 13px;
      color: rgba(255,255,255,.88);
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    input[type="checkbox"], input[type="radio"]{
      accent-color: var(--gold);
      width: 18px;
      height: 18px;
    }

    .footer-note{
      margin-top: 10px;
      font-size: 12px;
      color: rgba(255,255,255,.60);
      text-align:center;
      width: min(1100px, 100%);
    }

    .pulse{ animation: pulse 1.6s ease-in-out infinite; }
    @keyframes pulse{
      0%,100%{ box-shadow: 0 26px 52px rgba(0,0,0,.65), 0 0 30px rgba(255,204,51,.20); }
      50%{ box-shadow: 0 30px 60px rgba(0,0,0,.70), 0 0 42px rgba(255,204,51,.28); }
    }
  </style>
</head>

<body>
  <h1>Mafia Game</h1>

  <div class="top-wrap">
    <div class="panel">
      <h2>Setup</h2>

      <label for="players">Player names (comma-separated)</label>
      <input type="text" id="players" placeholder="e.g., Alice, Bob, Charlie, Dina, Asher" />

      <div class="row">
        <div style="flex:1; min-width: 160px;">
          <label for="num-mafia">Number of mafia</label>
          <input type="number" id="num-mafia" placeholder="e.g., 2" min="1" />
        </div>

        <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;">
          <button class="btn primary" id="btn-assign-random">Assign Roles Randomly</button>
          <button class="btn" id="btn-assign-manual">Assign Roles Manually</button>
          <button class="btn danger" id="btn-reset">Reset Game</button>
        </div>
      </div>

      <div class="hint">
        Tip: You need at least <strong>(mafia + 2)</strong> players to include a Medic and Detective.
      </div>

      <div id="setup-error" class="error"></div>
    </div>

    <div class="panel">
      <div class="status">
        <div class="badge" id="phase-badge">
          <span class="dot night" id="phase-dot"></span>
          <strong id="phase-text">Night</strong>
        </div>

        <div class="badge">
          Alive: <strong id="alive-count">0</strong>&nbsp; | &nbsp;Dead: <strong id="dead-count">0</strong>
        </div>

        <div class="badge">
          Timer: <strong id="timer-display">03:00</strong>
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <div style="flex:1; min-width:200px;">
          <label for="timer">Set Timer (mm:ss, m:ss, ss)</label>
          <input type="text" id="timer" value="03:00" />
        </div>
        <button class="btn" id="btn-set-timer" style="margin-top:22px;">Set Timer</button>
      </div>

      <div class="hint">
        During <strong>Day</strong>, the countdown appears on stage. You can pause/resume or end early.
      </div>
    </div>
  </div>

  <div class="stage-wrap">
    <div class="container" id="stage">
      <div id="player-list"></div>

      <div class="btn-next-phase" id="btn-next-phase" title="Advance phase">
        <div class="big" id="next-phase-main">Start</div>
        <div class="small" id="next-phase-sub">Assign roles to begin</div>
      </div>

      <div id="countdown-oval" class="countdown-oval" aria-live="polite">
        <div id="countdown">03:00</div>
        <div class="timer-actions">
          <button class="btn small" id="btn-pause">Pause</button>
          <button class="btn small" id="btn-resume" style="display:none;">Resume</button>
          <button class="btn danger small" id="btn-end-timer">End Timer</button>
        </div>
      </div>
    </div>

    <div class="footer-note">
      Moderator controls: click a nameplate to mark <strong>dead</strong>. Click a dead player to revive (confirmation).
    </div>
  </div>

  <!-- Revive confirm modal -->
  <div class="overlay" id="revive-overlay" role="dialog" aria-modal="true">
    <div class="modal">
      <h3>Revive player?</h3>
      <p id="revive-message"></p>
      <div class="actions">
        <button class="btn" id="btn-revive-no">No</button>
        <button class="btn primary" id="btn-revive-yes">Yes</button>
      </div>
    </div>
  </div>

  <!-- Manual assign modal -->
  <div class="overlay" id="manual-overlay" role="dialog" aria-modal="true">
    <div class="modal">
      <h3>Assign Roles Manually</h3>
      <p style="margin-top:0;color:rgba(255,255,255,.78);font-size:13px;">
        Choose exactly <strong id="need-mafia">0</strong> mafia, and optionally one Medic and one Detective.
      </p>

      <div class="columns">
        <div class="col">
          <h4>Mafia</h4>
          <div id="manual-mafia"></div>
        </div>
        <div class="col">
          <h4>Detective</h4>
          <div id="manual-detective"></div>
        </div>
        <div class="col">
          <h4>Medic</h4>
          <div id="manual-medic"></div>
        </div>
      </div>

      <div id="manual-error" class="error" style="display:none;"></div>

      <div class="actions">
        <button class="btn" id="btn-manual-cancel">Cancel</button>
        <button class="btn primary" id="btn-manual-confirm">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Win modal -->
  <div class="overlay" id="win-overlay" role="dialog" aria-modal="true">
    <div class="win-circle">
      <div id="win-message">Villagers Win!</div>
      <div class="win-sub" id="win-sub">Game over. Revive everyone to continue.</div>
      <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center; padding: 0 18px;">
        <button class="btn" id="btn-close-win">Close</button>
        <button class="btn primary" id="btn-revive-all">Revive All Players</button>
      </div>
    </div>
  </div>

  <script>
    // ======= Game State =======
    let players = [];
    let mafia = [];
    let medic = null;
    let detective = null;
    let deadPlayers = new Set();

    let gameStarted = false;
    let gameOver = false;
    let currentPhase = 'night';

    // Timer
    let timerValue = 180;
    let countdownInterval = null;
    let timeLeft = 180;
    let timerRunning = false;
    let timerPaused = false;

    // Revive modal
    let pendingRevive = null;

    // ======= DOM =======
    const el = {
      setupError: document.getElementById('setup-error'),
      manualError: document.getElementById('manual-error'),
      aliveCount: document.getElementById('alive-count'),
      deadCount: document.getElementById('dead-count'),
      phaseDot: document.getElementById('phase-dot'),
      phaseText: document.getElementById('phase-text'),
      timerInput: document.getElementById('timer'),
      timerDisplay: document.getElementById('timer-display'),
      stage: document.getElementById('stage'),
      playerList: document.getElementById('player-list'),
      nextPhaseBtn: document.getElementById('btn-next-phase'),
      nextPhaseMain: document.getElementById('next-phase-main'),
      nextPhaseSub: document.getElementById('next-phase-sub'),
      countdownOval: document.getElementById('countdown-oval'),
      countdown: document.getElementById('countdown'),
      btnPause: document.getElementById('btn-pause'),
      btnResume: document.getElementById('btn-resume'),
      btnEndTimer: document.getElementById('btn-end-timer'),
      reviveOverlay: document.getElementById('revive-overlay'),
      reviveMessage: document.getElementById('revive-message'),
      btnReviveYes: document.getElementById('btn-revive-yes'),
      btnReviveNo: document.getElementById('btn-revive-no'),
      manualOverlay: document.getElementById('manual-overlay'),
      needMafia: document.getElementById('need-mafia'),
      manualMafia: document.getElementById('manual-mafia'),
      manualDetective: document.getElementById('manual-detective'),
      manualMedic: document.getElementById('manual-medic'),
      btnManualCancel: document.getElementById('btn-manual-cancel'),
      btnManualConfirm: document.getElementById('btn-manual-confirm'),
      winOverlay: document.getElementById('win-overlay'),
      winMessage: document.getElementById('win-message'),
      winSub: document.getElementById('win-sub'),
      btnCloseWin: document.getElementById('btn-close-win'),
      btnReviveAll: document.getElementById('btn-revive-all'),
    };

    // Setup buttons
    document.getElementById('btn-assign-random').addEventListener('click', assignRolesRandomly);
    document.getElementById('btn-assign-manual').addEventListener('click', showManualAssignPopup);
    document.getElementById('btn-set-timer').addEventListener('click', () => setTimerFromInput(false));
    document.getElementById('btn-reset').addEventListener('click', resetGame);

    // Stage controls
    el.nextPhaseBtn.addEventListener('click', nextPhase);
    el.btnPause.addEventListener('click', pauseTimer);
    el.btnResume.addEventListener('click', resumeTimer);
    el.btnEndTimer.addEventListener('click', endTimerEarly);

    // Revive modal controls
    el.btnReviveYes.addEventListener('click', confirmRevive);
    el.btnReviveNo.addEventListener('click', closeReviveModal);
    el.reviveOverlay.addEventListener('click', (e) => { if(e.target === el.reviveOverlay) closeReviveModal(); });

    // Manual modal controls
    el.btnManualCancel.addEventListener('click', closeManualAssignPopup);
    el.manualOverlay.addEventListener('click', (e) => { if(e.target === el.manualOverlay) closeManualAssignPopup(); });
    el.btnManualConfirm.addEventListener('click', confirmManualAssign);

    // Win modal controls
    el.btnCloseWin.addEventListener('click', () => showOverlay(el.winOverlay, false));
    el.btnReviveAll.addEventListener('click', reviveAllPlayers);
    el.winOverlay.addEventListener('click', (e) => { if(e.target === el.winOverlay) showOverlay(el.winOverlay, false); });

    // Initialize
    updatePhaseUI();
    updateCounts();
    updateNextPhaseButton();
    setTimerFromInput(true);

    // ======= Helpers =======
    function showError(targetEl, msg){
      targetEl.textContent = msg;
      targetEl.style.display = 'block';
    }
    function clearError(targetEl){
      targetEl.textContent = '';
      targetEl.style.display = 'none';
    }
    function showOverlay(overlayEl, on){
      overlayEl.style.display = on ? 'flex' : 'none';
    }

    function parsePlayersInput(){
      const raw = document.getElementById('players').value || '';
      let list = raw.split(',')
        .map(s => s.trim())
        .filter(s => s.length > 0)
        .map(s => s.replace(/\s+/g,' '));

      const seen = new Set();
      const dups = new Set();
      for (const name of list){
        const key = name.toLowerCase();
        if(seen.has(key)) dups.add(name);
        seen.add(key);
      }
      return { list, dups: Array.from(dups) };
    }

    function formatTime(sec){
      const s = Math.max(0, Math.floor(sec));
      const m = Math.floor(s / 60);
      const r = s % 60;
      return `${m}:${r < 10 ? '0' : ''}${r}`;
    }

    function parseTimerInput(str){
      const t = (str || '').trim();
      if(!t) return null;
      if(t.includes(':')){
        const parts = t.split(':').map(p => p.trim());
        if(parts.length !== 2) return null;
        const mm = Number(parts[0]);
        const ss = Number(parts[1]);
        if(!Number.isFinite(mm) || !Number.isFinite(ss)) return null;
        if(mm < 0 || ss < 0) return null;
        return Math.floor(mm) * 60 + Math.min(59, Math.floor(ss));
      }
      const v = Number(t);
      if(!Number.isFinite(v) || v < 0) return null;
      return Math.floor(v);
    }

    function shuffle(array){
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function updateCounts(){
      const alive = players.filter(p => !deadPlayers.has(p)).length;
      el.aliveCount.textContent = String(alive);
      el.deadCount.textContent = String(deadPlayers.size);
    }

    function updatePhaseUI(){
      const isDay = currentPhase === 'day';
      el.phaseText.textContent = isDay ? 'Day' : 'Night';
      el.phaseDot.classList.toggle('day', isDay);
      el.phaseDot.classList.toggle('night', !isDay);
    }

    function updateNextPhaseButton(){
      if(!gameStarted){
        el.nextPhaseMain.textContent = 'Start';
        el.nextPhaseSub.textContent = 'Assign roles to begin';
        el.nextPhaseBtn.classList.remove('pulse');
        return;
      }
      if(gameOver){
        el.nextPhaseMain.textContent = 'Game Over';
        el.nextPhaseSub.textContent = 'Revive or reset';
        el.nextPhaseBtn.classList.remove('pulse');
        return;
      }
      if(currentPhase === 'night'){
        el.nextPhaseMain.textContent = 'Start Day';
        el.nextPhaseSub.textContent = 'Open timer';
      } else {
        el.nextPhaseMain.textContent = 'Start Night';
        el.nextPhaseSub.textContent = 'Hide timer';
      }
      el.nextPhaseBtn.classList.add('pulse');
    }

    function ensureGameReady(){
      if(!gameStarted){
        showError(el.setupError, 'Assign roles first to begin the game.');
        return false;
      }
      if(gameOver) return false;
      return true;
    }

    // ======= FIXED: Perfect ring placement =======
    function displayPlayers(){
      el.playerList.innerHTML = '';
      if(players.length === 0){
        updateCounts();
        return;
      }

      const rect = el.stage.getBoundingClientRect();
      const stageSize = Math.min(rect.width, rect.height);

      // read pill size from CSS variables
      const css = getComputedStyle(document.documentElement);
      const pillW = parseFloat(css.getPropertyValue('--pill-w')) || 132;
      const pillH = parseFloat(css.getPropertyValue('--pill-h')) || 58;

      // radius: keep pills on the rim but not clipped
      const safety = 18; // padding away from edge
      const radius = (stageSize / 2) - Math.max(pillW, pillH) / 2 - safety;

      const angleStep = (2 * Math.PI) / players.length;

      players.forEach((player, idx) => {
        const angle = idx * angleStep - Math.PI / 2; // top start

        const x = radius * Math.cos(angle);
        const y = radius * Math.sin(angle);

        const pill = document.createElement('div');
        pill.className = 'player-oval';
        if(deadPlayers.has(player)) pill.classList.add('dead');

        // lock to circle: center anchor + offsets
        pill.style.setProperty('--tx', `${x}px`);
        pill.style.setProperty('--ty', `${y}px`);

        const nameEl = document.createElement('div');
        nameEl.className = 'player-name';
        nameEl.textContent = player;

        pill.appendChild(nameEl);

        pill.addEventListener('click', () => togglePlayerStatus(player));
        el.playerList.appendChild(pill);
      });

      updateCounts();
    }

    window.addEventListener('resize', () => {
      if(players.length) displayPlayers();
    });

    // ======= Roles / Setup =======
    function validateSetup(list, numMafia){
      if(list.length < 1) return 'Enter at least one player name.';
      if(!Number.isFinite(numMafia) || numMafia < 1) return 'Enter a valid mafia count (minimum 1).';
      if(list.length < numMafia + 2) return `Not enough players. You need at least ${numMafia + 2} players for ${numMafia} mafia + Medic + Detective.`;
      if(numMafia > list.length - 2) return `Mafia count is too high. Max mafia for ${list.length} players is ${list.length - 2}.`;
      return null;
    }

    function resetRoundState(){
      mafia = [];
      medic = null;
      detective = null;
      deadPlayers = new Set();
    }

    function assignRolesRandomly(){
      clearError(el.setupError);
      clearError(el.manualError);

      const { list, dups } = parsePlayersInput();
      const numMafia = Number.parseInt(document.getElementById('num-mafia').value, 10);

      if(dups.length){
        showError(el.setupError, `Duplicate name detected. Make names unique. Example duplicate: "${dups[0]}".`);
        return;
      }

      const err = validateSetup(list, numMafia);
      if(err){
        showError(el.setupError, err);
        return;
      }

      resetRoundState();

      const working = list.slice();
      shuffle(working);

      mafia = working.slice(0, numMafia);
      medic = working[numMafia];
      detective = working[numMafia + 1];

      players = list.slice().sort((a,b) => a.localeCompare(b));

      gameStarted = true;
      gameOver = false;
      currentPhase = 'night';
      stopTimer(true);

      updatePhaseUI();
      updateNextPhaseButton();
      displayPlayers();

      alert(
        `Mafia: ${mafia.join(', ')}\n` +
        `Medic: ${medic}\n` +
        `Detective: ${detective}\n` +
        `Villagers: ${players.filter(p => !mafia.includes(p) && p !== medic && p !== detective).join(', ')}`
      );
    }

    // ======= Manual Assign =======
    function makeOption(type, id, groupName, index, label){
      const wrap = document.createElement('label');
      wrap.className = 'opt';

      const input = document.createElement('input');
      input.type = type;
      input.id = id;
      input.dataset.idx = String(index);
      input.dataset.role = groupName;

      if(type === 'radio') input.name = groupName;

      const text = document.createElement('span');
      text.textContent = label;

      wrap.appendChild(input);
      wrap.appendChild(text);
      return wrap;
    }

    function enforceManualRules(){
      clearError(el.manualError);

      const numMafia = Number(el.manualOverlay.dataset.numMafia);
      const list = JSON.parse(el.manualOverlay.dataset.players);

      const mafiaInputs = Array.from(el.manualOverlay.querySelectorAll('input[data-role="mafia"]'));
      const detInputs = Array.from(el.manualOverlay.querySelectorAll('input[data-role="detective"]'));
      const medInputs = Array.from(el.manualOverlay.querySelectorAll('input[data-role="medic"]'));

      const checkedMafia = mafiaInputs.filter(i => i.checked);
      if(checkedMafia.length > numMafia){
        checkedMafia[checkedMafia.length - 1].checked = false;
      }

      for(let i = 0; i < list.length; i++){
        const mi = mafiaInputs.find(x => Number(x.dataset.idx) === i);
        const di = detInputs.find(x => Number(x.dataset.idx) === i);
        const ci = medInputs.find(x => Number(x.dataset.idx) === i);

        if(mi?.checked){
          if(di) di.checked = false;
          if(ci) ci.checked = false;
        } else if(di?.checked){
          if(mi) mi.checked = false;
          if(ci) ci.checked = false;
        } else if(ci?.checked){
          if(mi) mi.checked = false;
          if(di) di.checked = false;
        }
      }
    }

    function showManualAssignPopup(){
      clearError(el.setupError);
      clearError(el.manualError);

      const { list, dups } = parsePlayersInput();
      const numMafia = Number.parseInt(document.getElementById('num-mafia').value, 10);

      if(dups.length){
        showError(el.setupError, `Duplicate name detected. Make names unique. Example duplicate: "${dups[0]}".`);
        return;
      }

      const err = validateSetup(list, numMafia);
      if(err){
        showError(el.setupError, err);
        return;
      }

      el.needMafia.textContent = String(numMafia);
      el.manualMafia.innerHTML = '';
      el.manualDetective.innerHTML = '';
      el.manualMedic.innerHTML = '';

      list.forEach((name, i) => {
        el.manualMafia.appendChild(makeOption('checkbox', `mafia_${i}`, 'mafia', i, name));
        el.manualDetective.appendChild(makeOption('radio', `detective_${i}`, 'detective', i, name));
        el.manualMedic.appendChild(makeOption('radio', `medic_${i}`, 'medic', i, name));
      });

      el.manualOverlay.dataset.numMafia = String(numMafia);
      el.manualOverlay.dataset.players = JSON.stringify(list);

      el.manualOverlay.querySelectorAll('input').forEach(inp => {
        inp.addEventListener('change', () => enforceManualRules());
      });

      showOverlay(el.manualOverlay, true);
      enforceManualRules();
    }

    function closeManualAssignPopup(){
      showOverlay(el.manualOverlay, false);
      clearError(el.manualError);
    }

    function confirmManualAssign(){
      clearError(el.manualError);

      const numMafia = Number(el.manualOverlay.dataset.numMafia);
      const list = JSON.parse(el.manualOverlay.dataset.players);

      const mafiaInputs = Array.from(el.manualOverlay.querySelectorAll('input[data-role="mafia"]'));
      const detInputs = Array.from(el.manualOverlay.querySelectorAll('input[data-role="detective"]'));
      const medInputs = Array.from(el.manualOverlay.querySelectorAll('input[data-role="medic"]'));

      const pickedMafiaIdx = mafiaInputs.filter(i => i.checked).map(i => Number(i.dataset.idx));
      if(pickedMafiaIdx.length !== numMafia){
        showError(el.manualError, `Select exactly ${numMafia} mafia.`);
        return;
      }

      const pickedDetective = detInputs.find(i => i.checked);
      const pickedMedic = medInputs.find(i => i.checked);

      resetRoundState();

      mafia = pickedMafiaIdx.map(i => list[i]);
      detective = pickedDetective ? list[Number(pickedDetective.dataset.idx)] : null;
      medic = pickedMedic ? list[Number(pickedMedic.dataset.idx)] : null;

      players = list.slice().sort((a,b)=>a.localeCompare(b));
      gameStarted = true;
      gameOver = false;
      currentPhase = 'night';
      stopTimer(true);

      updatePhaseUI();
      updateNextPhaseButton();
      displayPlayers();

      closeManualAssignPopup();

      alert(
        `Mafia: ${mafia.join(', ')}\n` +
        `Medic: ${medic ?? '(none)'}\n` +
        `Detective: ${detective ?? '(none)'}\n` +
        `Villagers: ${players.filter(p => !mafia.includes(p) && p !== medic && p !== detective).join(', ')}`
      );
    }

    // ======= Player toggling =======
    function togglePlayerStatus(player){
      if(!gameStarted){
        showError(el.setupError, 'Assign roles first to begin the game.');
        return;
      }
      if(gameOver) return;

      clearError(el.setupError);

      if(deadPlayers.has(player)){
        pendingRevive = player;
        el.reviveMessage.textContent = `Revive ${player}?`;
        showOverlay(el.reviveOverlay, true);
      } else {
        deadPlayers.add(player);
        displayPlayers();
        checkVictoryConditions();
      }
    }

    function closeReviveModal(){
      pendingRevive = null;
      showOverlay(el.reviveOverlay, false);
    }

    function confirmRevive(){
      if(pendingRevive){
        deadPlayers.delete(pendingRevive);
        pendingRevive = null;
        displayPlayers();
      }
      closeReviveModal();
    }

    // ======= Victory =======
    function checkVictoryConditions(){
      if(!gameStarted) return;

      const remainingMafia = mafia.filter(p => !deadPlayers.has(p));
      const remainingVillagers = players.filter(p => !deadPlayers.has(p) && !mafia.includes(p));

      if(remainingMafia.length === 0){
        endGame('Villagers Win!', 'All mafia have been eliminated.');
      } else if(remainingMafia.length >= remainingVillagers.length){
        endGame('Mafia Wins!', 'Mafia have reached parity with the town.');
      }
    }

    function endGame(title, subtitle){
      gameOver = true;
      stopTimer(true);
      el.winMessage.textContent = title;
      el.winSub.textContent = subtitle;
      updateNextPhaseButton();
      showOverlay(el.winOverlay, true);
    }

    function reviveAllPlayers(){
      deadPlayers = new Set();
      gameOver = false;
      currentPhase = 'night';
      stopTimer(true);
      updatePhaseUI();
      updateNextPhaseButton();
      displayPlayers();
      showOverlay(el.winOverlay, false);
    }

    // ======= Timer / Phases =======
    function setTimerFromInput(silent=false){
      const parsed = parseTimerInput(el.timerInput.value);
      if(parsed === null){
        if(!silent) showError(el.setupError, 'Timer format invalid. Use mm:ss, m:ss, or seconds.');
        return;
      }
      clearError(el.setupError);

      timerValue = Math.max(5, Math.min(60 * 60, parsed));
      el.timerDisplay.textContent = formatTime(timerValue);
      el.countdown.textContent = formatTime(timerValue);

      if(timerRunning){
        stopTimer(false);
        startDayTimer();
      }
    }

    function nextPhase(){
      if(!ensureGameReady()) return;

      if(currentPhase === 'night'){
        currentPhase = 'day';
        updatePhaseUI();
        updateNextPhaseButton();
        startDayTimer();
      } else {
        currentPhase = 'night';
        updatePhaseUI();
        updateNextPhaseButton();
        stopTimer(true);
      }
    }

    function startDayTimer(){
      stopTimer(false);

      timerRunning = true;
      timerPaused = false;
      timeLeft = timerValue;

      el.countdown.textContent = formatTime(timeLeft);
      el.countdownOval.style.display = 'flex';

      el.btnPause.style.display = 'inline-flex';
      el.btnResume.style.display = 'none';

      countdownInterval = setInterval(() => {
        if(timerPaused) return;

        timeLeft -= 1;
        el.countdown.textContent = formatTime(timeLeft);

        if(timeLeft <= 0){
          stopTimer(false);
          flashCountdownThenAdvance();
        }
      }, 1000);
    }

    function pauseTimer(){
      if(!timerRunning) return;
      timerPaused = true;
      el.btnPause.style.display = 'none';
      el.btnResume.style.display = 'inline-flex';
    }

    function resumeTimer(){
      if(!timerRunning) return;
      timerPaused = false;
      el.btnResume.style.display = 'none';
      el.btnPause.style.display = 'inline-flex';
    }

    function endTimerEarly(){
      if(!timerRunning) return;
      stopTimer(true);
      currentPhase = 'night';
      updatePhaseUI();
      updateNextPhaseButton();
    }

    function stopTimer(hideOval){
      if(countdownInterval){
        clearInterval(countdownInterval);
        countdownInterval = null;
      }
      timerRunning = false;
      timerPaused = false;
      el.btnPause.style.display = 'inline-flex';
      el.btnResume.style.display = 'none';
      if(hideOval){
        el.countdownOval.style.display = 'none';
      }
    }

    function flashCountdownThenAdvance(){
      el.countdown.textContent = '0:00';
      let flashes = 0;
      const flashTimer = setInterval(() => {
        el.countdown.style.visibility = (el.countdown.style.visibility === 'hidden') ? 'visible' : 'hidden';
        flashes++;
        if(flashes >= 10){
          clearInterval(flashTimer);
          el.countdown.style.visibility = 'visible';
          el.countdownOval.style.display = 'none';

          currentPhase = 'night';
          updatePhaseUI();
          updateNextPhaseButton();
        }
      }, 220);
    }

    // ======= Reset =======
    function resetGame(){
      stopTimer(true);
      mafia = [];
      medic = null;
      detective = null;
      deadPlayers = new Set();
      players = [];
      gameStarted = false;
      gameOver = false;
      currentPhase = 'night';

      updatePhaseUI();
      updateNextPhaseButton();
      el.playerList.innerHTML = '';
      updateCounts();
      clearError(el.setupError);
      clearError(el.manualError);

      showOverlay(el.reviveOverlay, false);
      showOverlay(el.manualOverlay, false);
      showOverlay(el.winOverlay, false);
    }
  </script>
</body>
</html>
